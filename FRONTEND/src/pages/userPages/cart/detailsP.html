<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cart Details</title>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom right, #eef2f3, #dfe9f3);
            color: #333;
        }

        #products-section {
            overflow: hidden;
        }

        h1, h2 {
            text-align: center;
            color: #2c3e50;
            margin-top: 20px;
        }

        .cart {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 30px auto;
            max-width: 1200px;
        }

        .cart-table {
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            font-family: monospace;
            margin-top: 20px;
        }

        .cart-header,
        .cart-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 0.5fr;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .cart-header {
            background-color: #f7f7f7;
            font-weight: bold;
        }

        .cart-row:nth-child(odd) {
            background-color: #f9f9f9;
        }

        .cart-row:nth-child(even) {
            background-color: #fff;
        }

        .cart-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .add-more-btn,
        .validate-btn {
            padding: 10px 16px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        .add-more-btn {
            background-color: #007bff;
            color: white;
        }

        .add-more-btn:hover {
            background-color: #0069d9;
        }

        .validate-btn {
            background-color: #ffc107;
            color: #333;
        }

        .validate-btn:hover {
            background-color: #e0a800;
        }

        .total {
            font-weight: bold;
            font-size: 18px;
            text-align: right;
            margin-top: 15px;
            font-family: monospace;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2rem;
        }

        @media screen and (max-width: 768px) {
            .cart-header,
            .cart-row {
                grid-template-columns: 2fr 1fr 1fr 1fr;
                font-size: 14px;
            }

            .cart-header span:nth-child(n+5),
            .cart-row span:nth-child(n+5) {
                display: none;
            }
        }

        @media screen and (max-width: 480px) {
            .cart {
                padding: 15px;
            }

            .cart-header,
            .cart-row {
                grid-template-columns: 2fr 1fr 1fr;
                padding: 8px 10px;
            }

            .cart-header span:nth-child(4),
            .cart-row span:nth-child(4) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light py-3 fixed-top">
        <div class="container">
          <a href="#"><img src="../media/logo/logo.jpg" alt="logo" class="img-fluid ms-4" style="width: 60px;height: auto; border-radius: 20px"></a>
          
          <!-- Bouton hamburger -->
          <div class="icon-wrapper">
            <ul>
              <li class="nav-item d-flex align-items-center " id="humicon">
                <i class="bx bx-search-alt nav-link search-btn3" id="SearchIcon3"></i>
                <i class="bx bx-x .icon-wrapper3 close-btn3" style="font-size: 1.8rem"></i>
              </li>
            </ul>
          </div>
      
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
      
          <!-- Menu de navigation -->
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="index.html" style="color: coral">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="../shopPage/sepecialOffer/specialOffer1.html">Shop</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">Blog</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">About</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#foter">Contact Us</a>
              </li>
              <!-- Icônes séparées -->
              <li class="nav-item d-flex align-items-center gap-2" id="humicon">
                <i class="bx bx-search-alt nav-link SearchIcon1 search-btn" id="SearchIcon2"></i>
                <i class="bx bx-x SearchIcon1 close-btn" id="closeIcon1" style="font-size: 1.8rem"></i>
                <a class="nav-link" href="/FRONTEND/src/pages/userPages/cart/detailsP.html"><i class="bx bx-shopping-bag"></i></a>
                
                <!-- Dynamic User/Login/Logout Section -->
                <div id="auth-section">
                  <!-- This will be populated by JavaScript based on login status -->
                </div>
              </li>
            </ul>
          </div>
          <div class="search-container">
            <input type="text" placeholder="Search here ..." name="" id="search-input2">
            <div id="autocomplete-results"></div>
            <div id="search-results"></div>
          </div>
        </div>
      </nav>

    <div class="container" style="margin-top: 100px;">
        <div class="cart">
            <h2>🛒 Your Cart</h2>
            <div class="cart-table">
                <div class="cart-header">
                    <span>Product</span>
                    <span>Size</span>
                    <span>Color</span>
                    <span>Total</span>
                    <span>Unit Price</span>
                    <span>Qty</span>
                    <span></span>
                </div>
                <div id="cart-items"></div>
            </div>
            <p class="total">Grand Total: $<span id="cart-total">0.00</span></p>
            <div class="cart-actions">
                <a href="../shopPage/sepecialOffer/specialOffer1.html">
                    <button class="add-more-btn">➕ Add More Products</button>
                </a>
                <button class="validate-btn" onclick="handleValidateClick()">✅ Checkout</button>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-5" id="foter">
      <div class="row container mx-auto">
          <div class="footer-one col-lg-3 col-md-6 col-12 mt-5">
              <a href="#"><img src="/FRONTEND/src/pages/userPages/media/logo/logo.jpg" alt="logo" class="img-fluid ms-4" id="imgend" style="width: 80px;height: auto; border-radius: 20px"></a>
              <p class="pt-3"><span style="color: coral;">IMAGINE WEAR</span> is the next step in our mission to improve commerce for everyone</p>
          </div>
          <div class="footer-one col-lg-3 col-md-6 col-12">
              <h5 class="pb-2">featured</h5>
              <ul class="text-uppercase list-unstyled">
                  <li><a href="../../shopPage/Tshirt/Tshirt1.html">T-shert</a></li>
                  <li><a href="../../shopPage/shirt/shirt1.html">Shert</a></li>
                  <li><a href="../../shopPage/hoodie/hoodie1.html">Hoodie</a></li>
                  <li><a href="../../shopPage/hot/hot1.html">Hot</a></li>
                  <li><a href="../../shopPage/pants/pants1.html">Pants</a></li>
                  <li><a href="../../shopPage/downJaket/downJaket1.html">Down Jacjet</a></li>
                  <li><a href="../../shopPage/jaket/jaket1.html">Jacjet</a></li>
              </ul>
          </div>

          <div class="footer-one col-lg-3 col-md-6 col-12">
              <h5 class="pb-2">Contact Us</h5>
              <ul class="text-uppercase list-unstyled">
                  <div>
                      <h6 class="text-uppercase">Address</h6>
                      <p>STREET Boukhiama, Bejaia, Algeria</p>
                  </div> 

                  <div>
                      <h6 class="text-uppercase">Phone</h6>
                      <p>+213552626468</p>
                  </div>

                  <div>
                      <h6 class="text-uppercase">Email</h6>
                      <p>imaginewear@gmail.com</p>
                  </div>
              </ul>
          </div>

          <div class="footer-one col-lg-3 col-md-6 col-12">
              <h5 class="pb-2">Social Media</h5>
              <ul class="text-uppercase list-unstyled">
                  <div>
                      <h6 class="text-uppercase">Instagram :</h6>
                      <p>imaginewear</p>
                  </div> 

                  <div>
                      <h6 class="text-uppercase">Facebook :</h6>
                      <p>imaginewear</p>
                  </div>

                  <div>
                      <h6 class="text-uppercase">X :</h6>
                      <p>imagine-wear</p>
                  </div>
              </ul>
          </div>
      </div>

      <div class="copyright mt-2">
          <div class="row container mx-auto">
              <div class="col-lg-3 col-md-6 col-12">
                  <img src="../../media/payment/payment1.png" style="width: 200px">            
              </div>
              <div class="col-lg-4 col-md-6 col-12 text-nowrap">
                  <p class="mt-2">Imagine Wear eCommerce © 2025. All Rights Reserved</p>
              </div>
          </div>
      </div>
  </footer>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Search functionality
        let searchBtn = document.querySelector('.search-btn');
        let closeBtn = document.querySelector('.close-btn');
        let searchBox = document.querySelector('.search-box');

        searchBtn.onclick = function() {
            searchBox.classList.add('active');
            closeBtn.classList.add('active');
            searchBtn.classList.add('active');
        }

        closeBtn.onclick = function() {
            searchBox.classList.remove('active');
            closeBtn.classList.remove('active');
            searchBtn.classList.remove('active');
        }

        let closeBtnSmall = document.querySelector('.close-btn3'); 
        let searchBtnSmall = document.querySelector('.search-btn3');

        searchBtnSmall.onclick = function() {
            searchBox.classList.add('active');
            closeBtnSmall.classList.add('active');
            searchBtnSmall.classList.add('active');
        }

        closeBtnSmall.onclick = function() {
            searchBox.classList.remove('active');
            closeBtnSmall.classList.remove('active');
            searchBtnSmall.classList.remove('active');
        }

        // Cart functionality
        document.addEventListener("DOMContentLoaded", async function() {
            await fetchAndDisplayCartItems();
        });

        async function fetchAndDisplayCartItems() {
            const token = localStorage.getItem("token");
            if (!token) {
                return Swal.fire({
                    icon: 'error',
                    title: 'Unauthorized',
                    text: 'You must be logged in to view your cart.'
                });
            }
            try {
                const response = await fetch("http://localhost:5000/getCartItems",{
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "authorization": `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch cart items');
                }
                const data = await response.json();
                displayCartItems(data.items);
            } catch (error) {
                console.error("Error fetching cart items:", error);
                document.getElementById('cart-items').innerHTML = 
                    '<div class="cart-row" style="text-align: center; grid-column: 1/-1;">Error loading cart items</div>';
            }
        }

        function displayCartItems(items) {
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalElement = document.getElementById('cart-total');

            cartItemsContainer.innerHTML = '';
            let grandTotal = 0;

            if (items.length === 0) {
                cartItemsContainer.innerHTML = '<div class="cart-row" style="text-align: center; grid-column: 1/-1;">Your cart is empty</div>';
                cartTotalElement.textContent = '0.00';
                return;
            }

            items.forEach(item => {
                const itemTotal = item.price * item.quantity;
                grandTotal += itemTotal;

                const cartRow = document.createElement('div');
                cartRow.className = 'cart-row';
                cartRow.innerHTML = `
                    <span>${item.name}</span>
                    <span>${item.size || 'N/A'}</span>
                    <span>${item.color || 'N/A'}</span>
                    <span>$${itemTotal.toFixed(2)}</span>
                    <span>$${item.price.toFixed(2)}</span>
                    <span>${item.quantity}</span>
                    <span><button class="remove-btn" onclick="removeItem(${item.order_item_id})">❌</button></span>
                `;
                cartItemsContainer.appendChild(cartRow);
            });

            cartTotalElement.textContent = grandTotal.toFixed(2);
        }

        async function removeItem(itemId) {
            try {
                const response = await fetch(`http://localhost:5000/deleteItem/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await fetchAndDisplayCartItems();
                } else {
                    const result = await response.json();
                    console.error("Delete failed:", result.error);
                    alert("Failed to remove item. Please try again.");
                }
            } catch (error) {
                console.error("Error removing item:", error);
                alert("Failed to remove item. Please try again.");
            }
        }

        async function handleValidateClick() {
    const { value: email } = await Swal.fire({
        title: 'Confirm your email',
        input: 'email',
        inputLabel: 'Enter your email to proceed with the order',
        inputPlaceholder: 'you@example.com',
        showCancelButton: true,
        confirmButtonText: 'Continue',
        cancelButtonText: 'Cancel',
        inputValidator: (value) => {
            if (!value) return 'Email is required';
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) return 'Invalid email format';
            return null;
        }
    });

    if (!email) return; // User cancelled

    const confirmResult = await Swal.fire({
        title: 'Confirm Order',
        text: `Place order for email: ${email}?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, place order',
        cancelButtonText: 'No, cancel'
    });

    if (!confirmResult.isConfirmed) return;

    const token = localStorage.getItem("token")|| prompt("enter the token");
    if (!token) {
        return Swal.fire({
            icon: 'error',
            title: 'Unauthorized',
            text: 'You must be logged in to place an order.'
        });
    }

    try {
        const response = await fetch("http://localhost:5000/createOrder", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({}) // optional: include email
        });

        const data = await response.json();

        if (response.ok) {
            await Swal.fire({
                icon: 'success',
                title: 'Order Created 🎉',
                html: `
                    <b>Order ID:</b> ${data.orderId}<br>
                    <b>Total:</b> $${data.total.toFixed(2)}
                `
            });
            window.location.href = "thankyou.html";
        } else {
            throw new Error(data.error || "Unknown error");
        }

    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Order Failed',
            text: error.message
        });
    }
}

    </script>
    <script src="/FRONTEND/src/pages/userPages/homePage/js/loginLogic.js"></script>
</body>
</html>
